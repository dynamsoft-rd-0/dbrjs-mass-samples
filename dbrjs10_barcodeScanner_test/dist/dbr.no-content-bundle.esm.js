/*!
* Dynamsoft JavaScript Library
* @product Dynamsoft Barcode Reader JS Edition Bundle
* @website http://www.dynamsoft.com
* @copyright Copyright 2025, Dynamsoft Corporation
* @author Dynamsoft
* @version 10.5.1000-dev-20250409173553
* @fileoverview Dynamsoft JavaScript Library for Barcode Reader
* More info on dbr JS: https://www.dynamsoft.com/barcode-reader/docs/web/programming/javascript/
*/
import{curScriptDir as e,getAbsoluteDir as t}from"@scannerproxy/curscript-path";import i from"mutable-promise";import{EnumCapturedResultItemType as o,CoreModule as n,_toCanvas as s,EnumImagePixelFormat as a}from"dynamsoft-core";export*from"dynamsoft-core";import{CaptureVisionRouter as r,CapturedResultReceiver as c}from"dynamsoft-capture-vision-router";export*from"dynamsoft-capture-vision-router";import{CameraView as l,CameraEnhancer as d}from"dynamsoft-camera-enhancer";export*from"dynamsoft-camera-enhancer";import{LicenseManager as u}from"dynamsoft-license";export*from"dynamsoft-license";import{MultiFrameResultCrossFilter as h}from"dynamsoft-utility";export*from"dynamsoft-utility";export*from"dynamsoft-barcode-reader";function m(e,t,i,o){if("a"===i&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?o:"a"===i?o.call(e):o?o.value:t.get(e)}function f(e,t,i,o,n){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?n.call(e,i):n?n.value=i:t.set(e,i),i}var g,p,y;"function"==typeof SuppressedError&&SuppressedError,function(e){e[e.SM_SINGLE=0]="SM_SINGLE",e[e.SM_MULTI_UNIQUE=1]="SM_MULTI_UNIQUE"}(g||(g={})),function(e){e[e.OM_NONE=0]="OM_NONE",e[e.OM_SPEED=1]="OM_SPEED",e[e.OM_COVERAGE=2]="OM_COVERAGE",e[e.OM_BALANCE=3]="OM_BALANCE",e[e.OM_DPM=4]="OM_DPM",e[e.OM_DENSE=5]="OM_DENSE"}(p||(p={})),function(e){e[e.RS_SUCCESS=0]="RS_SUCCESS",e[e.RS_CANCELLED=1]="RS_CANCELLED",e[e.RS_FAILED=2]="RS_FAILED"}(y||(y={}));var w={license:"",scanMode:g.SM_SINGLE,templateFilePath:void 0,utilizedTemplateNames:{single:"ReadSingleBarcode",multi_unique:"ReadBarcodes_SpeedFirst",image:"ReadBarcodes_ReadRateFirst"},engineResourcePaths:{rootDirectory:e},barcodeFormats:void 0,duplicateForgetTime:3e3,container:void 0,onUniqueBarcodeScanned:void 0,showResultView:!1,showUploadImageButton:!1,scannerViewConfig:{container:void 0,showCloseButton:!1},resultViewConfig:{container:void 0,toolbarButtonsConfig:{clear:{label:"Clear",className:"btn-clear",isHidden:!1},done:{label:"Done",className:"btn-done",isHidden:!1}}}};const S=()=>window.matchMedia("(orientation: landscape)").matches;function _(e,t){for(const o in t)"Object"===(i=t[o],Object.prototype.toString.call(i).slice(8,-1))&&o in e?_(e[o],t[o]):e[o]=t[o];var i;return e}var E,b,R,v,C,I,M,N,x,q,T,L,A,O,V,U,B,F,D,G,P;class k{constructor(e){if(E.add(this),v.set(this,void 0),C.set(this,{status:{code:y.RS_SUCCESS,message:"Successfully."},barcodeResults:[]}),I.set(this,!1),M.set(this,void 0),N.set(this,void 0),this.config=w,e&&"object"!=typeof e||Array.isArray(e))throw"Invalid config.";_(this.config,e)}async launch(){if(m(this,I,"f"))throw new Error("The BarcodeScanner instance has been destroyed.");if(m(k,b,"f",R)&&!m(k,b,"f",R).isFulfilled)throw new Error("Cannot call `launch()` while a previous task is still running.");return f(k,b,new i,"f",R),await m(this,E,"m",x).call(this),m(k,b,"f",R)}async decode(e,t){return this._cvRouter.capture(e,t)}dispose(){f(this,I,!0,"f"),m(k,b,"f",R)&&m(k,b,"f",R).isPending&&m(k,b,"f",R).resolve(m(this,C,"f")),this._cameraEnhancer?.dispose(),this._cameraView?.dispose(),this._cvRouter?.dispose(),this._cameraEnhancer=null,this._cameraView=null,this._cvRouter=null,window.removeEventListener("resize",m(this,v,"f")),document.querySelector(".scanner-view-container")?.remove(),document.querySelector(".result-view-container")?.remove(),document.querySelector(".barcode-scanner-container")?.remove(),document.querySelector(".loading-page")?.remove()}}b=k,v=new WeakMap,C=new WeakMap,I=new WeakMap,M=new WeakMap,N=new WeakMap,E=new WeakSet,x=async function(){try{await m(this,E,"m",q).call(this);let e=this.config.utilizedTemplateNames.multi_unique;this.config.scanMode===g.SM_SINGLE?e=this.config.utilizedTemplateNames.single:this.config.scanMode===g.SM_MULTI_UNIQUE&&(e=this.config.utilizedTemplateNames.multi_unique);const t=await this._cvRouter.getSimplifiedSettings(e);t.capturedResultItemTypes=o.CRIT_ORIGINAL_IMAGE|o.CRIT_BARCODE,await this._cvRouter.updateSettings(e,t);try{await this._cameraEnhancer.open()}catch(e){m(this,E,"m",P).call(this);document.querySelector(".no-camera-view").style.display="flex"}await this._cvRouter.startCapturing(e)}catch(e){m(this,C,"f").status={code:y.RS_FAILED,message:e.message||e},m(k,b,"f",R).reject(m(this,C,"f")),this.dispose()}finally{const e=document.querySelector(".loading-page");e&&(e.style.display="none")}},q=async function(){u.initLicense(this.config.license||"",{executeNow:!0}),n.engineResourcePaths=this.config.engineResourcePaths,n.loadWasm([]),this._cameraView=await l.createInstance(),this.config.scanMode===g.SM_SINGLE&&(this._cameraView._capturedResultReceiver.onCapturedResultReceived=()=>{}),await m(this,E,"m",L).call(this),this._cameraEnhancer=await d.createInstance(this._cameraView),this._cvRouter=await r.createInstance(),await m(this,E,"m",T).call(this),this._cvRouter.setInput(this._cameraEnhancer),m(this,E,"m",A).call(this),await m(this,E,"m",O).call(this)},T=async function(){f(this,N,this.config.utilizedTemplateNames.multi_unique,"f"),this.config.scanMode===g.SM_SINGLE?f(this,N,this.config.utilizedTemplateNames.single,"f"):this.config.scanMode===g.SM_MULTI_UNIQUE&&f(this,N,this.config.utilizedTemplateNames.multi_unique,"f"),this.config.templateFilePath&&await this._cvRouter.initSettings(this.config.templateFilePath);const e=await this._cvRouter.getSimplifiedSettings(m(this,N,"f"));if(e.capturedResultItemTypes=o.CRIT_ORIGINAL_IMAGE|o.CRIT_BARCODE,this.config.barcodeFormats){const e=await this._cvRouter.getSimplifiedSettings(m(this,N,"f"));e.barcodeSettings.barcodeFormatIds=BigInt(0);for(let t=0;t<this.config.barcodeFormats.length;t++)e.barcodeSettings.barcodeFormatIds|=this.config.barcodeFormats[t]}if(await this._cvRouter.updateSettings(m(this,N,"f"),e),this.config.scanMode===g.SM_SINGLE){const e=await this._cvRouter.outputSettings("*");for(let t of e.CaptureVisionTemplates){const e=await this._cvRouter.getSimplifiedSettings(t.Name);e.barcodeSettings.expectedBarcodesCount=1,await this._cvRouter.updateSettings(t.Name,e)}}},L=async function(){const i=this.config.scannerViewConfig.cameraEnhancerUIPath||e,o=t(i)+"barcode-scanner.ui.html",n=await(async e=>{if("string"!=typeof e)throw new TypeError("Invalid url.");const t=await fetch(e);if(!t.ok)throw Error("Network Error: "+t.statusText);const i=await t.text();if(!i.trim().startsWith("<"))throw Error("Unable to get valid HTMLElement.");const o=document.createElement("div");if(o.insertAdjacentHTML("beforeend",i),1===o.childElementCount&&o.firstChild instanceof HTMLTemplateElement)return o.firstChild.content;const n=new DocumentFragment;for(let e of o.children)n.append(e);return n})(o);n.querySelectorAll("style").forEach((e=>{document.head.appendChild(e.cloneNode(!0))})),f(this,M,n.querySelector(".result-item"),"f");const s=n.querySelector(".btn-clear");if(s.addEventListener("click",(()=>{m(this,C,"f").barcodeResults=[],m(this,E,"m",D).call(this)})),this.config?.resultViewConfig?.toolbarButtonsConfig?.clear){const e=this.config.resultViewConfig.toolbarButtonsConfig.clear;s.style.display=e.isHidden?"none":"flex",s.className=e.className?e.className:"btn-clear",s.innerText=e.label?e.label:"Clear",e.isHidden&&(n.querySelector(".toolbar-btns").style.justifyContent="center")}const a=n.querySelector(".btn-done");if(a.addEventListener("click",(()=>{const e=document.querySelector(".loading-page");e&&"none"===getComputedStyle(e).display&&this.dispose()})),this.config?.resultViewConfig?.toolbarButtonsConfig?.done){const e=this.config.resultViewConfig.toolbarButtonsConfig.done;a.style.display=e.isHidden?"none":"flex",a.className=e.className?e.className:"btn-done",a.innerText=e.label?e.label:"Done",e.isHidden&&(n.querySelector(".toolbar-btns").style.justifyContent="center")}const r=this.config?.scannerViewConfig?.showCloseButton;if(r){const e=n.querySelector(".btn-close");e.style.display="",e.addEventListener("click",(()=>{m(this,C,"f").barcodeResults=[],m(this,C,"f").status={code:y.RS_CANCELLED,message:"Canceled."},this.dispose()}))}this.config.showUploadImageButton&&m(this,E,"m",P).call(this,n.querySelector(".btn-upload-image"));const c=this._cameraView.getUIElement();c.shadowRoot.querySelector(".dce-sel-camera").remove(),c.shadowRoot.querySelector(".dce-sel-resolution").remove(),this._cameraView.setVideoFit("cover");const l=n.querySelector(".barcode-scanner-container");l.style.display=S()?"flex":"";const d=this.config.showResultView&&this.config.scanMode!==g.SM_SINGLE;let u;if(this.config.container?(l.style.position="relative",u=this.config.container):u=document.body,"string"==typeof u&&(u=document.querySelector(u),null===u))throw new Error("Failed to get the container");let h=this.config.scannerViewConfig.container;if("string"==typeof h&&(h=document.querySelector(h),null===h))throw new Error("Failed to get the container of the scanner view.");let p=this.config.resultViewConfig.container;if("string"==typeof p&&(p=document.querySelector(p),null===p))throw new Error("Failed to get the container of the result view.");const w=n.querySelector(".scanner-view-container"),_=n.querySelector(".result-view-container"),b=n.querySelector(".loading-page");w.append(b),h&&(w.append(c),h.append(w)),p&&p.append(_),h||p?h&&!p?(this.config.container||(_.style.position="absolute"),p=_,u.append(_)):!h&&p&&(this.config.container||(w.style.position="absolute"),h=w,w.append(c),u.append(w)):(h=w,p=_,d&&(Object.assign(w.style,{width:S()?"50%":"100%",height:S()?"100%":"50%"}),Object.assign(_.style,{width:S()?"50%":"100%",height:S()?"100%":"50%"})),w.append(c),u.append(l)),document.querySelector(".result-view-container").style.display=d?"":"none",f(this,v,(()=>{Object.assign(l.style,{display:S()?"flex":""}),!d||this.config.scannerViewConfig.container||this.config.resultViewConfig.container||(Object.assign(h.style,{width:S()?"50%":"100%",height:S()?"100%":"50%"}),Object.assign(p.style,{width:S()?"50%":"100%",height:S()?"100%":"50%"}))}),"f"),window.addEventListener("resize",m(this,v,"f")),this._cameraView._createDrawingLayer(2)},A=function(){const e=new c;let t=0;e.onCapturedResultReceived=async e=>{e.barcodeResultItems&&(this.config.scanMode===g.SM_SINGLE?2==++t&&m(this,E,"m",V).call(this,e):m(this,E,"m",U).call(this,e))},this._cvRouter.addResultReceiver(e)},O=async function(){const e=new h;e.enableResultCrossVerification(2,!0),e.enableResultDeduplication(2,!0),e.setDuplicateForgetTime(2,this.config.duplicateForgetTime),e.onDecodedBarcodesReceived=()=>{},await this._cvRouter.addResultFilter(e)},V=function(e){const t=this._cameraView.getUIElement().shadowRoot;new Promise((i=>{if(e.barcodeResultItems.length>1){m(this,E,"m",F).call(this);for(let o of e.barcodeResultItems){let e=0,n=0;for(let t=0;t<4;++t){let i=o.location.points[t];e+=i.x,n+=i.y}let s=this._cameraEnhancer.convertToClientCoordinates({x:e/4,y:n/4}),a=document.createElement("div");a.className="single-barcode-result-option",Object.assign(a.style,{position:"fixed",width:"32px",height:"32px",border:"#fff solid 4px","box-sizing":"border-box","border-radius":"16px",background:"#080",cursor:"pointer",transform:"translate(-50%, -50%)"}),a.style.left=s.x+"px",a.style.top=s.y+"px",a.addEventListener("click",(()=>{i(o)})),t.append(a)}}else i(e.barcodeResultItems[0])})).then((t=>{const i=e.items.filter((e=>e.type===o.CRIT_ORIGINAL_IMAGE))[0].imageData,n={status:{code:y.RS_SUCCESS,message:"Successfully."},originalImageResult:i,barcodeImage:(()=>{const e=s(i),o=t.location.points,n=Math.min(...o.map((e=>e.x))),r=Math.min(...o.map((e=>e.y))),c=Math.max(...o.map((e=>e.x)))-n,l=Math.max(...o.map((e=>e.y)))-r,d=document.createElement("canvas");d.width=c,d.height=l;const u=d.getContext("2d");u.beginPath(),u.moveTo(o[0].x-n,o[0].y-r);for(let e=1;e<o.length;e++)u.lineTo(o[e].x-n,o[e].y-r);u.closePath(),u.clip(),u.drawImage(e,-n,-r);const h=u.getImageData(0,0,d.width,d.height);return{bytes:new Uint8Array(h.data),width:h.width,height:h.height,stride:4*h.width,format:a.IPF_ARGB_8888}})(),barcodeResults:[t]};m(k,b,"f",R).resolve(n),this.dispose()}))},U=function(e){const t=[...document.querySelectorAll(".main-list .result-item")];for(let i of e.barcodeResultItems){if(i.duplicate)return;const e=t.findIndex((e=>e.id===`${i.formatString}_${i.text}`));-1===e?(i.count=1,m(this,C,"f").barcodeResults.unshift(i),m(this,E,"m",D).call(this,i)):(m(this,C,"f").barcodeResults[e].count++,m(this,E,"m",G).call(this,e)),this.config.onUniqueBarcodeScanned&&this.config.onUniqueBarcodeScanned(i)}},B=function(e){const t=m(this,M,"f").cloneNode(!0);t.querySelector(".format-string").innerText=e.formatString;t.querySelector(".text-string").innerText=e.text.replace(/\n|\r/g,""),t.id=`${e.formatString}_${e.text}`;return t.querySelector(".delete-icon").addEventListener("click",(()=>{const t=[...document.querySelectorAll(".main-list .result-item")],i=t.findIndex((t=>t.id===`${e.formatString}_${e.text}`));m(this,C,"f").barcodeResults.splice(i,1),t[i].remove()})),t},F=function(){const e=this._cameraView.getUIElement().shadowRoot;if(e.querySelector(".single-mode-mask"))return;const t=document.createElement("div");t.className="single-mode-mask",Object.assign(t.style,{width:"100%",height:"100%",position:"absolute",top:"0",left:"0",right:"0",bottom:"0","background-color":"#4C4C4C",opacity:"0.5"}),e.append(t),this._cameraEnhancer.pause(),this._cvRouter.stopCapturing()},D=function(e){const t=document.querySelector(".no-result-svg");if(!(this.config.showResultView&&this.config.scanMode!==g.SM_SINGLE))return;const i=document.querySelector(".main-list");if(!e)return i.textContent="",void(t.style.display="");t.style.display="none";const o=m(this,E,"m",B).call(this,e);i.insertBefore(o,document.querySelector(".result-item"))},G=function(e){const t=document.querySelectorAll(".main-list .result-item"),i=t[e].querySelector(".result-count");let o=parseInt(i.textContent.replace("X",""));t[e].querySelector(".result-count").textContent="X"+ ++o},P=function(e){e||(e=document.querySelector(".btn-upload-image")),e&&(e.style.display="",e.addEventListener("change",(async e=>{const t=e.target.files,i={status:{code:y.RS_SUCCESS,message:"Successfully."},barcodeResults:[]};for(let e of t)try{const t=await this.decode(e,this.config.utilizedTemplateNames.image);t.barcodeResultItems&&i.barcodeResults.push(...t.barcodeResultItems)}catch(e){i.status={code:y.RS_FAILED,message:e.message||e}}m(k,b,"f",R).resolve(i),this.dispose()})))},R={value:null},r._defaultTemplate="ReadSingleBarcode";export{k as BarcodeScanner,p as EnumOptimizationMode,y as EnumResultStatus,g as EnumScanMode};
